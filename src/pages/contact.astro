---
import BaseLayout from '../layouts/BaseLayout.astro';

const FORMSUBMIT_ACTION = import.meta.env.PUBLIC_FORMSUBMIT_ACTION as string;
if (!FORMSUBMIT_ACTION) {
  console.warn('PUBLIC_FORMSUBMIT_ACTION is not set');
}
---

<BaseLayout title="Contact â€” Diego Henriquez">
  <section class="flex flex-col justify-center items-center min-h-[80vh] text-center px-4">
    <div class="w-full max-w-xl">
      <h1 class="text-2xl md:text-3xl font-bold mb-6">Contact</h1>

      <form id="contactForm" action={FORMSUBMIT_ACTION} method="POST" class="space-y-4 text-left">

        <input type="hidden" name="_subject" value="New message from your portfolio" />
        <input type="hidden" name="_captcha" value="false" />

        <input type="text" name="_honey" class="hidden" tabindex="-1" autocomplete="off" />

        <div>
          <label class="block text-sm mb-1 font-medium text-neutral-700">Name</label>
          <input 
            required 
            name="name"
            class="w-full rounded-xl border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"
          />
        </div>

        <div>
          <label class="block text-sm mb-1 font-medium text-neutral-700">Email</label>
          <input
            required
            type="email"
            name="email"
            class="w-full rounded-xl border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"
          />
        </div>

        <div>
          <label class="block text-sm mb-1 font-medium text-neutral-700">Message</label>
          <textarea
            required
            name="message"
            rows="5"
            class="w-full rounded-xl border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"
          ></textarea>
        </div>

        <button
          type="submit"
          class="w-full rounded-xl bg-brand-600 text-white px-4 py-2 font-medium hover:bg-brand-700 transition-colors disabled:opacity-60"
        >
          Send
        </button>
      </form>
    </div>
  </section>

  <div
    id="toast"
    class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden rounded-xl px-4 py-3 shadow-lg text-white"
    role="status"
    aria-live="polite"
  ></div>

  <script>
    const form = document.getElementById('contactForm') as HTMLFormElement | null;
    const toast = document.getElementById('toast') as HTMLDivElement | null;

    function showToast(message: string, variant: 'success' | 'error' = 'success', timeout = 3000) {
      if (!toast) return;
      toast.textContent = message;
      toast.className =
        'fixed bottom-6 left-1/2 -translate-x-1/2 z-50 rounded-xl px-4 py-3 shadow-lg text-white ' +
        (variant === 'success' ? 'bg-green-600' : 'bg-red-600');
      toast.classList.remove('hidden');
      window.setTimeout(() => toast.classList.add('hidden'), timeout);
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
        if (btn) btn.disabled = true;

        // Honeypot check
        const honey = form.querySelector('input[name="_honey"]') as HTMLInputElement | null;
        if (honey && honey.value) {
          showToast('Error: spam detected.', 'error');
          if (btn) btn.disabled = false;
          return;
        }

        try {
          const formData = new FormData(form);
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { Accept: 'application/json' },
            body: formData,
          });

          if (res.ok) {
            form.reset();
            showToast('Thank you! Your message has been sent successfully.', 'success');
          } else {
            showToast('Failed to send your message. Please try again later.', 'error');
          }
        } catch {
          showToast('A network error occurred. Please try again later.', 'error');
        } finally {
          if (btn) btn.disabled = false;
        }
      });
    }
  </script>
</BaseLayout>
